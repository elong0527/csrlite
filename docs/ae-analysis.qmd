---
title: "Adverse Event Analysis"
---

::: {.callout-note}
## Objectives

Generate adverse event analysis outputs following ROD:
:::

## Setup

First, let's import the required packages and load our study plan.

```{python}
#| message: false
import sys
from pathlib import Path
import polars as pl

# Add src to path for imports
sys.path.insert(0, str(Path.cwd().parent / 'src'))
```

```{python}
from tlfyaml import load_plan, ae_summary_ard, ae_summary, ae_summary_to_rtf
```

## Load Study Plan

The study plan is defined in YAML format with template inheritance. It contains population definitions, observation periods, parameters, and data source specifications.

```{python}
# Load study plan from YAML
study_plan = load_plan("examples/yaml/plan_xyz123.yaml")
```

```{python}
adsl = study_plan.datasets["adsl"]
adae = study_plan.datasets["adae"]
```

# Overview 

We break the function into three steps 

`*_ard`: create an analysis ready data in long format. 
`*_df`: create a data frame following exact format of the TLF.
`*_tlf`: format TLF and save into a file. 

# AE Summary 

Here `ae_summary` is a wrapper of the `ae_summary_ard`, `ae_summary_df` and `ae_summary_tlf` function. 

::: {.callout-note}
We keep it simple and focus on the concept, one can refactor it into a class and add additional validation to make it production ready.
:::

## Function call

## Internal function

### Prepare analysis ready data 

```{python}
_ard = ae_summary_ard(
    population=adsl,
    observation=adae,
    population_filter="SAFFL = 'Y'",
    observation_filter=None,
    group=("TRT01A", "Treatment Group"),
    variables=[
        ("TRTEMFL = 'Y'", "Any Adverse Events"),
        ("AESER = 'Y'", "Serious Adverse Events")
    ],
    id=("USUBJID", "Subject ID"),
    total=True,
    missing_group="error"
)

_ard
```

### Prepare TLF ready data 

```{python}
_ard.pivot(index = "__index__", on = "__group__", values = "__value__")
```

## Generate AE Summary Table

The `ae_summary()` function generates summary tables with counts and percentages by treatment group.

```{python}
# Generate AE summary for treatment-emergent AEs
result_summary = ae_summary(
    study_plan=study_plan,
    population="apat",        # All Participants As Treated
    observation=None,         # All observations (no time restriction)
    parameter="any",          # Any adverse event
    group="trt01a"           # Treatment group variable
)

result_summary
```

### Display Metadata

```{python}
result_summary["meta"]
```

### Population Denominators

The denominators show the number of subjects in each treatment group.

```{python}
result_summary["n_pop"]
```

### AE Summary Results

The summary table shows both SOC-level and PT-level counts with percentages. Results are sorted by frequency (highest to lowest).

```{python}
result_summary["summary"]
```

## Generate RTF Table Output

The `ae_summary_to_rtf()` function converts AE summary results into production-ready RTF tables using the rtflite package. The output format matches the metalite.ae R package style, suitable for regulatory submissions.

```{python}
# Generate AE summary with multiple parameters
result_summary_multi = ae_summary(
    study_plan=study_plan,
    population="apat",
    observation=None,
    parameter="any;rel;ser",  # Semicolon-separated for multiple parameters
    group="trt01a"
)

# Generate RTF table from AE summary result
rtf_output = ae_summary_to_rtf(
    result_summary_multi,
    study_plan=study_plan,
    title="Summary of Adverse Events",
    subtitle=["Weeks 0 to 12", "All Participants as Treated"],
    output_file="../ae_summary.rtf"
)
```
