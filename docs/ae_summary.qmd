---
title: "Adverse Event Analysis"
---

::: {.callout-note}
## Objectives

Generate adverse event analysis outputs following ROD:
:::

## Setup

First, let's import the required packages and load our study plan.

```{python}
#| message: false
import sys
from pathlib import Path
import polars as pl
import rtflite as rtf 

# Add src to path for imports
sys.path.insert(0, str(Path.cwd().parent / 'src'))
```

```{python}
from tlfyaml import load_plan, study_plan_to_ae_summary
from tlfyaml.ae_summary import ae_summary_ard, ae_summary_df, ae_summary_rtf, ae_summary
```

## AE Summary with analysis plan 

The study plan is defined in YAML format with template inheritance. It contains population definitions, observation periods, parameters, and data source specifications.

```{python}
# Load study plan from YAML
study_plan = load_plan("examples/yaml/plan_xyz123.yaml")
study_plan.get_plan_df().filter(pl.col("analysis") == "ae_summary")
```

In production, we expect one call to get all AE summary analysis defined in the study plan.

```{python}
study_plan_to_ae_summary(study_plan)
```


# Overview 

We look into the design. Overall the `ae_summary` break into three steps 

`*_ard`: create an analysis ready data in long format. 
`*_df`: create a data frame following exact format of the TLF.
`*_tlf`: format TLF and save into a file. 

# AE Summary 

Here `ae_summary` is a wrapper of the `ae_summary_ard`, `ae_summary_df` and `ae_summary_tlf` function. 

::: {.callout-note}
We keep it simple and focus on the concept, one can refactor it into a class and add additional validation to make it production ready.
:::

## Complete Pipeline

The `ae_summary` function provides a complete pipeline that executes all three steps and writes the RTF output to a file:

```{python}
adsl = pl.read_parquet("data/adsl.parquet")
adae = pl.read_parquet("data/adae.parquet")

ae_summary(
    population=adsl,
    observation=adae,
    population_filter="SAFFL = 'Y'",
    observation_filter=None,
    id=("USUBJID", "Subject ID"),
    group=("TRT01A", "Treatment Group"),
    variables=[
        ("TRTEMFL = 'Y'", "Any Adverse Events"),
        ("AESER = 'Y'", "Serious Adverse Events")
    ],
    title=[
        "Analysis of Adverse Event Summary",
        "(Safety Analysis Population)"
    ],
    footnote=["Every participant is counted a single time for each applicable row and column."],
    source=["Source: ADSL and ADAE datasets"],
    output_file="examples/rtf/ae_summary.rtf",
    total=True,
    missing_group="error"
)
```

## Step-by-Step Pipeline

### Prepare analysis ready data 

```{python}
_ard = ae_summary_ard(
    population=adsl,
    observation=adae,
    population_filter="SAFFL = 'Y'",
    observation_filter=None,
    group=("TRT01A", "Treatment Group"),
    variables=[
        ("TRTEMFL = 'Y'", "Any Adverse Events"),
        ("AESER = 'Y'", "Serious Adverse Events")
    ],
    id=("USUBJID", "Subject ID"),
    total=True,
    missing_group="error"
)

_ard
```

### Prepare TLF ready data 

```{python}
_rtf = ae_summary_df(_ard)
_rtf
```

### Prepare RTF output

Using the `ae_summary_rtf()` function for streamlined RTF generation:

```{python}
ae_summary_rtf(
    _rtf,
    title=[
        "Analysis of Adverse Event Summary",
        "(Safety Analysis Population)"
    ],
    footnote=["Every participant is counted a single time for each applicable row and column."],
    source=["Source: ADSL and ADAE datasets"],
    col_rel_width=[4, 2, 2, 2, 2]  # Optional: defaults to auto-calculated widths
).write_rtf("examples/rtf/ae_summary.rtf")
```

